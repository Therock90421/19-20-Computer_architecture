`timescale 1ns / 1ps
//////////////////////////////////////////////////////////////////////////////////
// Company: 
// Engineer: 
// 
// Create Date: 2019/09/11 16:48:21
// Design Name: 
// Module Name: calculator
// Project Name: 
// Target Devices: 
// Tool Versions: 
// Description: 
// 
// Dependencies: 
// 
// Revision:
// Revision 0.01 - File Created
// Additional Comments:
// 
//////////////////////////////////////////////////////////////////////////////////


module signed_multi(A,B,sign,result,RESULT);
	input   [31:0]  A,B;        //34位乘法
	input          sign;
	output  [67:0] result;     //68位结果
	output  [63:0] RESULT;     //64位结果
	wire    [33:0]  a,b;        //两个输入
	wire    [31:0]  A,B;
	wire            sign;
	wire    [34:0]  bnum;       //乘数，在最后补0
	wire    [67:0] result;      //乘积
	wire    [63:0] RESULT; 
	wire    [67:0] sum;         //S
	wire    [67:0] fin_c;       //C
	wire    [67:0] C;           //C左移1位
	wire    [13:0] c;           //最底层华莱士树的进位输入
	wire    c_14,c_15;          //c_14接在68位加法器中C的末位，c_15接在68位加法器中的进位
	wire    [13:0] cout[67:0];  //华莱士树中的进位链
	wire     [67:0]  p[16:0];   //17个部分和
	
    assign a = (sign)?{{2{A[31]}},A}:{2'd0,A};
    assign b = (sign)?{{2{B[31]}},B}:{2'd0,B};
	assign bnum = {b,1'b0};
	assign p[0] =  (bnum[2:0] == 3'b000)?68'd0
	               :(bnum[2:0] == 3'b001||bnum[2:0] == 3'b010)? {{34{a[33]}},a}
	               :(bnum[2:0] == 3'b011)?{{33{a[31]}},a,1'b0}
	               :(bnum[2:0] == 3'b100)?{{33{~a[31]}},~a,1'b1}
	               :(bnum[2:0] == 3'b101||bnum[2:0] == 3'b110)?{{34{~a[33]}},~a}
	               :68'd0;
	 assign c[0] = (bnum[2:0] == 3'b100||bnum[2:0] == 3'b101||bnum[2:0] == 3'b110)?1'b1:1'b0;
	 
	 assign p[1] =  (bnum[4:2] == 3'b000)?68'd0
                    :(bnum[4:2] == 3'b001||bnum[2:0] == 3'b010)? {{32{a[33]}},a,2'd0}
                    :(bnum[4:2] == 3'b011)?{{31{a[31]}},a,3'd0}
                    :(bnum[4:2] == 3'b100)?{{31{~a[31]}},~a,{3{1'd1}}}
                    :(bnum[4:2] == 3'b101||bnum[4:2] == 3'b110)?{{32{~a[33]}},~a,{2{1'd1}}}
                    :68'd0;
     assign c[1] = (bnum[4:2] == 3'b100||bnum[4:2] == 3'b101||bnum[4:2] == 3'b110)?1'b1:1'b0;
     
     assign p[2] =   (bnum[6:4] == 3'b000)?68'd0
                     :(bnum[6:4] == 3'b001||bnum[6:4] == 3'b010)? {{30{a[33]}},a,4'd0}
                     :(bnum[6:4] == 3'b011)?{{29{a[31]}},a,5'd0}
                     :(bnum[6:4] == 3'b100)?{{29{~a[31]}},~a,{5{1'd1}}}
                     :(bnum[6:4] == 3'b101||bnum[6:4] == 3'b110)?{{30{~a[33]}},~a,{4{1'd1}}}
                     :68'd0;
     assign c[2] =  (bnum[6:4] == 3'b100||bnum[6:4] == 3'b101||bnum[6:4] == 3'b110)?1'b1:1'b0;
     
     assign p[3] =   (bnum[8:6] == 3'b000)?68'd0
                      :(bnum[8:6] == 3'b001||bnum[8:6] == 3'b010)? {{28{a[33]}},a,6'd0}
                      :(bnum[8:6] == 3'b011)?{{27{a[31]}},a,7'd0}
                      :(bnum[8:6] == 3'b100)?{{27{~a[31]}},~a,{7{1'd1}}}
                      :(bnum[8:6] == 3'b101||bnum[8:6] == 3'b110)?{{28{~a[33]}},~a,{6{1'd1}}}
                      :68'd0;
      assign c[3] =  (bnum[8:6] == 3'b100||bnum[8:6] == 3'b101||bnum[8:6] == 3'b110)?1'b1:1'b0;
      
      assign p[4] =   (bnum[10:8] == 3'b000)?68'd0
                       :(bnum[10:8] == 3'b001||bnum[10:8] == 3'b010)? {{26{a[33]}},a,8'd0}
                       :(bnum[10:8] == 3'b011)?{{25{a[31]}},a,9'd0}
                       :(bnum[10:8] == 3'b100)?{{25{~a[31]}},~a,{9{1'd1}}}
                       :(bnum[10:8] == 3'b101||bnum[10:8] == 3'b110)?{{26{~a[33]}},~a,{8{1'd1}}}
                       :68'd0;
      assign c[4] =  (bnum[10:8] == 3'b100||bnum[10:8] == 3'b101||bnum[10:8] == 3'b110)?1'b1:1'b0;
      
      assign p[5] =   (bnum[12:10] == 3'b000)?68'd0
                       :(bnum[12:10] == 3'b001||bnum[12:10] == 3'b010)? {{24{a[33]}},a,10'd0}
                       :(bnum[12:10] == 3'b011)?{{23{a[31]}},a,11'd0}
                       :(bnum[12:10] == 3'b100)?{{23{~a[31]}},~a,{11{1'd1}}}
                       :(bnum[12:10] == 3'b101||bnum[12:10] == 3'b110)?{{24{~a[33]}},~a,{10{1'd1}}}
                       :68'd0;
      assign c[5] =  (bnum[12:10] == 3'b100||bnum[12:10] == 3'b101||bnum[12:10] == 3'b110)?1'b1:1'b0;
      
      assign p[6] =   (bnum[14:12] == 3'b000)?68'd0
                       :(bnum[14:12] == 3'b001||bnum[14:12] == 3'b010)? {{22{a[33]}},a,12'd0}
                       :(bnum[14:12] == 3'b011)?{{21{a[31]}},a,13'd0}
                       :(bnum[14:12] == 3'b100)?{{21{~a[31]}},~a,{13{1'd1}}}
                       :(bnum[14:12] == 3'b101||bnum[14:12] == 3'b110)?{{22{~a[33]}},~a,{12{1'd1}}}
                       :68'd0;
      assign c[6] =  (bnum[14:12] == 3'b100||bnum[14:12] == 3'b101||bnum[14:12] == 3'b110)?1'b1:1'b0;
      
      assign p[7] =   (bnum[16:14] == 3'b000)?68'd0
                       :(bnum[16:14] == 3'b001||bnum[16:14] == 3'b010)? {{20{a[33]}},a,14'd0}
                       :(bnum[16:14] == 3'b011)?{{19{a[31]}},a,15'd0}
                       :(bnum[16:14] == 3'b100)?{{19{~a[31]}},~a,{15{1'd1}}}
                       :(bnum[16:14] == 3'b101||bnum[16:14] == 3'b110)?{{20{~a[33]}},~a,{14{1'd1}}}
                       :68'd0;
      assign c[7] =  (bnum[16:14] == 3'b100||bnum[16:14] == 3'b101||bnum[16:14] == 3'b110)?1'b1:1'b0;
      
      assign p[8] =   (bnum[18:16] == 3'b000)?68'd0
                       :(bnum[18:16] == 3'b001||bnum[18:16] == 3'b010)? {{18{a[33]}},a,16'd0}
                       :(bnum[18:16] == 3'b011)?{{17{a[31]}},a,17'd0}
                       :(bnum[18:16] == 3'b100)?{{17{~a[31]}},~a,{17{1'd1}}}
                       :(bnum[18:16] == 3'b101||bnum[18:16] == 3'b110)?{{18{~a[33]}},~a,{16{1'd1}}}
                       :68'd0;
      assign c[8] =  (bnum[18:16] == 3'b100||bnum[18:16] == 3'b101||bnum[18:16] == 3'b110)?1'b1:1'b0;
      
      assign p[9] =   (bnum[20:18] == 3'b000)?68'd0
                       :(bnum[20:18] == 3'b001||bnum[20:18] == 3'b010)? {{16{a[33]}},a,18'd0}
                       :(bnum[20:18] == 3'b011)?{{15{a[31]}},a,19'd0}
                       :(bnum[20:18] == 3'b100)?{{15{~a[31]}},~a,{19{1'd1}}}
                       :(bnum[20:18] == 3'b101||bnum[20:18] == 3'b110)?{{16{~a[33]}},~a,{18{1'd1}}}
                       :68'd0;
     assign c[9] =  (bnum[20:18] == 3'b100||bnum[20:18] == 3'b101||bnum[20:18] == 3'b110)?1'b1:1'b0;
     
     assign p[10] =   (bnum[22:20] == 3'b000)?68'd0
                        :(bnum[22:20] == 3'b001||bnum[22:20] == 3'b010)? {{14{a[33]}},a,20'd0}
                        :(bnum[22:20] == 3'b011)?{{13{a[31]}},a,21'd0}
                        :(bnum[22:20] == 3'b100)?{{13{~a[31]}},~a,{21{1'd1}}}
                        :(bnum[22:20] == 3'b101||bnum[22:20] == 3'b110)?{{14{~a[33]}},~a,{20{1'd1}}}
                        :68'd0;
     assign c[10] =  (bnum[22:20] == 3'b100||bnum[22:20] == 3'b101||bnum[22:20] == 3'b110)?1'b1:1'b0;
     
     assign p[11] =   (bnum[24:22] == 3'b000)?68'd0
                        :(bnum[24:22] == 3'b001||bnum[24:22] == 3'b010)? {{12{a[33]}},a,22'd0}
                        :(bnum[24:22] == 3'b011)?{{11{a[31]}},a,23'd0}
                        :(bnum[24:22] == 3'b100)?{{11{~a[31]}},~a,{23{1'd1}}}
                        :(bnum[24:22] == 3'b101||bnum[24:22] == 3'b110)?{{12{~a[33]}},~a,{22{1'd1}}}
                        :68'd0;
     assign c[11] =  (bnum[24:22] == 3'b100||bnum[24:22] == 3'b101||bnum[24:22] == 3'b110)?1'b1:1'b0;
     
     assign p[12] =   (bnum[26:24] == 3'b000)?68'd0
                        :(bnum[26:24] == 3'b001||bnum[26:24] == 3'b010)? {{10{a[33]}},a,24'd0}
                        :(bnum[26:24] == 3'b011)?{{9{a[31]}},a,25'd0}
                        :(bnum[26:24] == 3'b100)?{{9{~a[31]}},~a,{25{1'd1}}}
                        :(bnum[26:24] == 3'b101||bnum[26:24] == 3'b110)?{{10{~a[33]}},~a,{24{1'd1}}}
                        :68'd0;
     assign c[12] =  (bnum[26:24] == 3'b100||bnum[26:24] == 3'b101||bnum[26:24] == 3'b110)?1'b1:1'b0;
     
     assign p[13] =   (bnum[28:26] == 3'b000)?68'd0
                        :(bnum[28:26] == 3'b001||bnum[28:26] == 3'b010)? {{8{a[33]}},a,26'd0}
                        :(bnum[28:26] == 3'b011)?{{7{a[31]}},a,27'd0}
                        :(bnum[28:26] == 3'b100)?{{7{~a[31]}},~a,{27{1'd1}}}
                        :(bnum[28:26] == 3'b101||bnum[28:26] == 3'b110)?{{8{~a[33]}},~a,{26{1'd1}}}
                        :68'd0;
    assign c[13] =  (bnum[28:26] == 3'b100||bnum[28:26] == 3'b101||bnum[28:26] == 3'b110)?1'b1:1'b0;
    
    assign p[14] =   (bnum[30:28] == 3'b000)?68'd0
                        :(bnum[30:28] == 3'b001||bnum[30:28] == 3'b010)? {{6{a[33]}},a,28'd0}
                        :(bnum[30:28] == 3'b011)?{{5{a[31]}},a,29'd0}
                        :(bnum[30:28] == 3'b100)?{{5{~a[31]}},~a,{29{1'd1}}}
                        :(bnum[30:28] == 3'b101||bnum[30:28] == 3'b110)?{{6{~a[33]}},~a,{28{1'd1}}}
                        :68'd0;
    assign c_14 =  (bnum[30:28] == 3'b100||bnum[30:28] == 3'b101||bnum[30:28] == 3'b110)?1'b1:1'b0;
    //c[14]
    assign p[15] =   (bnum[32:30] == 3'b000)?68'd0
                            :(bnum[32:30] == 3'b001||bnum[32:30] == 3'b010)? {{4{a[33]}},a,30'd0}
                            :(bnum[32:30] == 3'b011)?{{3{a[31]}},a,31'd0}
                            :(bnum[32:30] == 3'b100)?{{3{~a[31]}},~a,{31{1'd1}}}
                            :(bnum[32:30] == 3'b101||bnum[32:30] == 3'b110)?{{4{~a[33]}},~a,{30{1'd1}}}
                            :68'd0;
    assign c_15 =  (bnum[32:30] == 3'b100||bnum[32:30] == 3'b101||bnum[32:30] == 3'b110)?1'b1:1'b0;
	//c[15]          
	assign p[16] =   (bnum[34:32] == 3'b000)?68'd0
                             :(bnum[34:32] == 3'b001||bnum[34:32] == 3'b010)? {{2{a[33]}},a,30'd0}
                             :(bnum[34:32] == 3'b011)?{{1{a[31]}},a,31'd0}
                             :(bnum[34:32] == 3'b100)?{{1{~a[31]}},~a,{31{1'd1}}}
                             :(bnum[34:32] == 3'b101||bnum[34:32] == 3'b110)?{{2{~a[33]}},~a,{30{1'd1}}}
                             :68'd0;     
	
	
	
	
	
	
	
	
	
	wallace w1(p[0][0],p[1][0],p[2][0],p[3][0],p[4][0],p[5][0],p[6][0],p[7][0],p[8][0],p[9][0],p[10][0],p[11][0],p[12][0],p[13][0],p[14][0],p[15][0],p[16][0],c,cout[0],sum[0],fin_c[0]);
	generate
	    genvar i;
	    for(i = 1; i < 68; i = i+1)
	    begin: inst_module
	    wallace w(p[0][i],p[1][i],p[2][i],p[3][i],p[4][i],p[5][i],p[6][i],p[7][i],p[8][i],p[9][i],p[10][i],p[11][i],p[12][i],p[13][i],p[14][i],p[15][i],p[16][i],cout[i-1],cout[i],sum[i],fin_c[i]);
	    end
	endgenerate
	
	assign C = {fin_c[66:0],c_14};
	assign result = C + sum + c_15;
    assign RESULT = result[63:0];
endmodule

module add(a,b,cin,s,cout);
	input wire a,b,cin;
	output wire s,cout;
	assign {cout,s} = a + b + cin;
endmodule
module wallace(a0,a1,a2,a3,a4,a5,a6,a7,a8,a9,a10,a11,a12,a13,a14,a15,a16,cin,cout,s,c);
    input wire a0,a1,a2,a3,a4,a5,a6,a7,a8,a9,a10,a11,a12,a13,a14,a15,a16;
    input wire [13:0] cin;
    output wire s;
    output wire [13:0] cout;
    output wire c;
    wire s1,s2,s3,s4,s5,s6,s7,s8,s9,s10,s11,s12,s13,s14,s15;
    add add1(a16,a15,a14,s1,cout[0]);
    add add2(a13,a12,a11,s2,cout[1]);
    add add3(a10,a9,a8,s3,cout[2]);
    add add4(a7,a6,a5,s4,cout[3]);
    add add5(a4,a3,a2,s5,cout[4]);
    add add6(s1,s2,s3,s6,cout[5]);
    add add7(s4,s5,a1,s7,cout[6]);
    add add8(a0,cin[0],cin[1],s8,cout[7]);
    add add9(cin[2],cin[3],cin[4],s9,cout[8]);
    add add10(s6,s7,s8,s10,cout[9]);
    add add11(s9,cin[5],cin[6],s11,cout[10]);
    add add12(s10,s11,cin[7],s12,cout[11]);
    add add13(cin[8],cin[9],cin[10],s13,cout[12]);
    add add14(s12,s13,cin[11],s14,cout[13]);
    add add15(s14,cin[12],cin[13],s,c);
    
    endmodule
    
    

